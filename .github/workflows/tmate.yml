name: Create VPS (Auto Restart 24/7)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

env:
  VPS_NAME: vps-project-1762939380543
  TMATE_SERVER: nyc1.tmate.io
  GITHUB_TOKEN_VPS: ${{ secrets.GH_TOKEN }}
  NGROK_SERVER_URL: https://vps-github.vercel.app

jobs:
  deploy:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: write

    steps:

    - name: ‚¨áÔ∏è Checkout source
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: üêç T·∫°o file VPS info
      run: |
        mkdir -Force links
        "VPS kh·ªüi t·∫°o - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File links/${{ env.VPS_NAME }}.txt -Encoding utf8

    - name: üñ•Ô∏è C√†i ƒë·∫∑t v√† ch·∫°y TightVNC, noVNC, Cloudflared
      shell: pwsh
      run: |
        ############################################################
        #  ==== VPS SETUP START ====
        ############################################################

        Write-Host "üì• Installing TightVNC..."
        Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.63/tightvnc-2.8.63-gpl-setup-64bit.msi" -OutFile "tightvnc.msi"
        Start-Process msiexec.exe -Wait -ArgumentList '/i tightvnc.msi /quiet /norestart ADDLOCAL="Server" SET_PASSWORD=1 VALUE_OF_PASSWORD=hieudz'
        Write-Host "‚úÖ TightVNC installed"

        Write-Host "üîß Enabling loopback..."
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name AllowLoopback -Value 1 -Force

        Stop-Process -Name "tvnserver" -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 3

        Start-Process "C:\Program Files\TightVNC\tvnserver.exe" "-run -localhost no"
        Start-Sleep -Seconds 20

        Write-Host "üì• Installing Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

        Write-Host "üöÄ Starting Cloudflared tunnel..."
        Start-Process ./cloudflared.exe "tunnel --url http://localhost:6080 --no-autoupdate --logfile cloudflared.log"
        Start-Sleep -Seconds 25

        Write-Host "üì• Installing noVNC..."
        Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/tags/v1.6.0.zip" -OutFile noVNC.zip
        Expand-Archive noVNC.zip -DestinationPath .
        Move-Item noVNC-1.6.0 noVNC

        Write-Host "üöÄ Starting websockify..."
        python -m pip install websockify
        Start-Process python "-m websockify 6080 localhost:5900 --web noVNC" -WindowStyle Hidden
        Start-Sleep -Seconds 12

        ############################################################
        #  ==== GET CLOUDFLARED LINK ====
        ############################################################

        $cf_url = ""
        for ($i=1; $i -le 150; $i++) {
          if (Test-Path cloudflared.log) {
            $log = Get-Content cloudflared.log -Raw
            if ($log -match 'https://[a-zA-Z0-9-]+\.trycloudflare\.com') {
              $cf_url = $matches[0]
              break
            }
          }
          Start-Sleep -Seconds 3
        }

        if (-not $cf_url) {
          $cf_url = "FAILED_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
        }

        $remote = "$cf_url/vnc.html"
        $remote | Out-File remote-link.txt -Encoding utf8

        ############################################################
        # ‚úì Ghi commit (ch·ªëng spam)
        ############################################################

        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"

        git add remote-link.txt
        git commit -m "üîó Update VNC Link" || echo "No changes"
        git push origin main --force-with-lease


        ############################################################
        #  ==== MAIN LOOP (360 minutes / auto restart) ====
        ############################################################

        $totalMinutes = 360
        $restartCheckpoint = 355

        for ($i=1; $i -le $totalMinutes; $i++) {
          Write-Host "üü¢ VPS Running - Minute $i/$totalMinutes"
          Start-Sleep -Seconds 60
        }

        Write-Host "‚è∞ Session end - preparing auto restart..."

    - name: üîÑ Auto Restart Workflow
      if: always()
      shell: pwsh
      run: |
        $currentTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        "RESTART_$currentTime" | Out-File restart.lock

        Write-Host "üîÅ Restarting workflow..."

        $headers = @{
          "Accept" = "application/vnd.github+json"
          "Authorization" = "Bearer $env:GITHUB_TOKEN_VPS"
          "Content-Type" = "application/json"
        }

        $payload = @{
          event_type = "create-vps"
          client_payload = @{
            auto_restart = $true
            restart_time = $currentTime
          }
        } | ConvertTo-Json -Depth 2

        Start-Sleep -Seconds 5

        Invoke-RestMethod `
          -Uri "https://api.github.com/repos/Davexyzss/${{ env.VPS_NAME }}/dispatches" `
          -Method POST `
          -Headers $headers `
          -Body $payload

        git add restart.lock
        git commit -m "üîÑ Auto restart $currentTime" || echo "No changes"
        git push origin main --force-with-lease

        Write-Host "‚úÖ Restart request sent!"
